<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Pusher</title>
	<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
	<script src="https://js.pusher.com/4.1/pusher.min.js"></script>
  	
</head>
<body>
	<h1>Pusher chat</h1>
	<div>
		<input type="text" id="user_id" placeholder="id">
		<input type="text" id="user_info" placeholder="name">
		<button onclick="Connnect();">start</button>
		<button onclick="Disconect();">end</button>
	</div>
	<div id="chat"></div>
	<div id="chat-message"></div>
	<input type="text" id="user_message" placeholder="message">
	<button onclick="Send();">send</button>
	<script type="text/javascript">
		 // Enable pusher logging - don't include this in production
    	Pusher.logToConsole = true;
		var APP_KEY = '8ddcdf34609e091e8806';
        var APP_CLUSTER = 'us2';
        var HOST = 'http://8a6de384.ngrok.io/v1/pusher/auth'

        //
        var pusher = null;
        var socketId = null;
        var sessionId = null;
        var state = null;
        /*const socket = new Pusher(APP_KEY, {
            cluster: APP_CLUSTER,
            authEndpoint: 'http://8a6de384.ngrok.io/pusher/auth',   
            encrypted: true
        });
        console.log('socket');
        console.log(socket);*/
        // first connection
        function Connnect(){
        	console.log(document.getElementById('user_id').value);
        	console.log(document.getElementById('user_info').value);
        	pusher = new Pusher(APP_KEY, {
		      cluster: APP_CLUSTER,
		      encrypted: true,
		      auth: {
			    params: { 
			    	CSRFToken: 'here goes jwt' //for improve management
			    },
			    headers: { 
			    	X-CSRF-Token: 'some_csrf_token'
			    }
			  }
		    });
		    sessionId = pusher.sessionID;
		    console.log('pusher');
		    console.log(pusher);
		    // subscribe to channel
	        var channel = pusher.subscribe('my-channel');
	    		channel.bind('my-event', function(data) {
	    		console.log('channel bind my-event');
	      		console.log('channel event: ' + data);
	      		document.getElementById('chat-message').innerHTML += '<br>' +data.message + ' - from ' + data.user_name;
	    	});
	    	console.log('channel');
	    	console.log(channel);
	    	// listen for events
	    	//channel.bind('my-event', function(data) {
			  //alert('An event was triggered with message: ' + data.message);
			  //document.getElementById('chat-message').innerHTML += '<br>' +data.message;
			//});

			

			// detect when user is reconecting and show pending time 
			pusher.connection.bind('connecting_in', function(delay) {
			  alert("I haven't been able to establish a connection for this feature.  " +
			        "I will try again in " + delay + " seconds.");
			});
			// detect real time connection
			pusher.connection.bind('connected', function() {
			  socketId = pusher.connection.socket_id;
			  console.log('socket_id: ' + socketId);
			});
			// detect when state changes
			state = pusher.connection.state;
			pusher.connection.bind('state_change', function(states) {
			  // states = {previous: 'oldState', current: 'newState'}
			  document.getElementById('chat').innerHTML += " <br> Pusher's current state is " + states.current;
			});
			// detect errors
			pusher.connection.bind( 'error', function( err ) {
			  if( err.error.data.code === 4004 ) {
			    log('>>> detected limit error');
			  }
			});
        }
        /** send message */
        function Send(){
        	var msg = document.getElementById('user_message').value;
        	var usr_name = document.getElementById('user_info').value;
        	console.log(msg);
        	$.ajax({
			      method: 'POST',
			      url: "http://1936e10d.ngrok.io/v1/pusher/auth",
			      data: { 
			      	"message" :msg,
			      	"user_name" : usr_name,
			      	"socket_id" : socketId,
		      	  },
			      dataType: "application/json",
			      headers: {"Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxMiwibmFtZSI6Ikx1aXMgUmF1bCBCZXRhIiwibGFzdF9uYW1lIjoiRXNwaW5vemEgQmFyYm96YSIsImVtYWlsIjoibHVpcy5lc3Bpbm96YUBidWlsZGJpbmRlci5jb20iLCJleHAiOjE1MTMyMDI4MjJ9.T5Ef23XN2dAqouUGxfjgc0uvy9GsfZoj3qeT6x7VzX0"},
			      success: function(resultData) { alert("Save Complete") }
			});
        }
        /** disconect */
        function Disconect(){
        	pusher.disconnect();
        }
	</script>
</body>
</html>